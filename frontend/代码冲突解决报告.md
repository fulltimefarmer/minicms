# ğŸ”§ ä»£ç å†²çªè§£å†³æŠ¥å‘Š

## é—®é¢˜è¯Šæ–­

### ğŸš¨ å‘ç°çš„ä¸»è¦é—®é¢˜
**localStorage is not defined** é”™è¯¯

### ğŸ” é—®é¢˜åŸå› 
Angular 20 é¡¹ç›®é»˜è®¤å¯ç”¨äº†**æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰**ï¼Œè€Œ `localStorage` åªåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­å­˜åœ¨ï¼Œåœ¨æœåŠ¡å™¨ç¯å¢ƒä¸­ä¸å¯ç”¨ã€‚

### ğŸ“ é”™è¯¯ä½ç½®
- `frontend/src/app/app.ts` - getCurrentUser() å’Œ logout() æ–¹æ³•
- `frontend/src/app/login.component.ts` - onSubmit() æ–¹æ³•

### ğŸ’¥ å…·ä½“é”™è¯¯ä¿¡æ¯
```
ERROR ReferenceError: localStorage is not defined
    at e.getCurrentUser (file:///workspace/frontend/.angular/prerender-root/...
```

## è§£å†³æ–¹æ¡ˆ

### âœ… å®æ–½çš„ä¿®å¤

#### 1. ä¿®å¤ä¸»åº”ç”¨ç»„ä»¶ (`app.ts`)

**ä¿®æ”¹å‰:**
```typescript
getCurrentUser(): User | null {
  const userStr = localStorage.getItem('currentUser');
  return userStr ? JSON.parse(userStr) : null;
}

logout(): void {
  localStorage.removeItem('currentUser');
  this.router.navigate(['/login']);
}
```

**ä¿®æ”¹å:**
```typescript
import { Component, Inject, PLATFORM_ID } from '@angular/core';
import { CommonModule, isPlatformBrowser } from '@angular/common';

constructor(
  private router: Router,
  @Inject(PLATFORM_ID) private platformId: Object
) {}

getCurrentUser(): User | null {
  if (isPlatformBrowser(this.platformId)) {
    const userStr = localStorage.getItem('currentUser');
    return userStr ? JSON.parse(userStr) : null;
  }
  return null;
}

logout(): void {
  if (isPlatformBrowser(this.platformId)) {
    localStorage.removeItem('currentUser');
  }
  this.router.navigate(['/login']);
}
```

#### 2. ä¿®å¤ç™»å½•ç»„ä»¶ (`login.component.ts`)

**ä¿®æ”¹å‰:**
```typescript
onSubmit() {
  const user = this.permissionService.validateLogin(this.username, this.password);
  if (user) {
    localStorage.setItem('currentUser', JSON.stringify(user));
    this.router.navigate(['/permission-management']);
  }
}
```

**ä¿®æ”¹å:**
```typescript
import { Component, Inject, PLATFORM_ID } from '@angular/core';
import { CommonModule, isPlatformBrowser } from '@angular/common';

constructor(
  private router: Router,
  private permissionService: PermissionService,
  @Inject(PLATFORM_ID) private platformId: Object
) {}

onSubmit() {
  const user = this.permissionService.validateLogin(this.username, this.password);
  if (user) {
    if (isPlatformBrowser(this.platformId)) {
      localStorage.setItem('currentUser', JSON.stringify(user));
    }
    this.router.navigate(['/permission-management']);
  }
}
```

### ğŸ”§ æŠ€æœ¯åŸç†

#### å¹³å°æ£€æµ‹æœºåˆ¶
- ä½¿ç”¨ `@Inject(PLATFORM_ID)` æ³¨å…¥å¹³å°æ ‡è¯†ç¬¦
- ä½¿ç”¨ `isPlatformBrowser()` æ£€æµ‹å½“å‰æ˜¯å¦åœ¨æµè§ˆå™¨ç¯å¢ƒ
- åªåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­è®¿é—® `localStorage`

#### SSR å…¼å®¹æ€§
- æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶ï¼ŒlocalStorage ç›¸å…³ä»£ç ä¸ä¼šæ‰§è¡Œ
- æµè§ˆå™¨ç«¯è¿è¡Œæ—¶ï¼ŒlocalStorage åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- ä¿è¯äº†åº”ç”¨åœ¨ä¸¤ç§ç¯å¢ƒä¸‹éƒ½èƒ½æ­£å¸¸è¿è¡Œ

## éªŒè¯ç»“æœ

### âœ… æ„å»ºæˆåŠŸ
```bash
npm run build
# âœ“ Browser bundles: 335.83 kB
# âœ“ Server bundles: 810.66 kB  
# âœ“ Prerendered 3 static routes
# âœ“ Application bundle generation complete
```

### âœ… è§£å†³çš„é—®é¢˜
1. **ç¼–è¯‘é”™è¯¯** - localStorage undefined é”™è¯¯å·²è§£å†³
2. **SSR å…¼å®¹** - åº”ç”¨ç°åœ¨å®Œå…¨å…¼å®¹æœåŠ¡å™¨ç«¯æ¸²æŸ“
3. **åŠŸèƒ½å®Œæ•´** - æ‰€æœ‰æƒé™ç®¡ç†åŠŸèƒ½ä¿æŒæ­£å¸¸

### âœ… åŠŸèƒ½éªŒè¯
- âœ… ç”¨æˆ·ç™»å½•åŠŸèƒ½
- âœ… ç”¨æˆ·çŠ¶æ€ç®¡ç†
- âœ… æƒé™ç®¡ç†é¡µé¢
- âœ… è·¯ç”±å¯¼èˆª
- âœ… æœåŠ¡å™¨ç«¯æ¸²æŸ“

## æœ€ä½³å®è·µå»ºè®®

### ğŸ›¡ï¸ SSR ç¯å¢ƒä¸‹çš„ localStorage ä½¿ç”¨æ¨¡å¼

```typescript
// æ¨èçš„æ¨¡å¼
if (isPlatformBrowser(this.platformId)) {
  // åªåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä½¿ç”¨ localStorage
  localStorage.setItem(key, value);
}

// æˆ–è€…åˆ›å»ºä¸€ä¸ªæœåŠ¡æ¥å¤„ç†
@Injectable({
  providedIn: 'root'
})
export class StorageService {
  constructor(@Inject(PLATFORM_ID) private platformId: Object) {}
  
  setItem(key: string, value: string): void {
    if (isPlatformBrowser(this.platformId)) {
      localStorage.setItem(key, value);
    }
  }
  
  getItem(key: string): string | null {
    if (isPlatformBrowser(this.platformId)) {
      return localStorage.getItem(key);
    }
    return null;
  }
}
```

### ğŸ¯ å…¶ä»– Web API æ³¨æ„äº‹é¡¹
ä»¥ä¸‹ Web API åœ¨ SSR ç¯å¢ƒä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œéœ€è¦ç±»ä¼¼å¤„ç†ï¼š
- `window` å¯¹è±¡
- `document` å¯¹è±¡  
- `sessionStorage`
- `navigator`
- DOM æ“ä½œç›¸å…³ API

### ğŸ“‹ æ£€æŸ¥æ¸…å•
- [x] æ‰€æœ‰ localStorage ä½¿ç”¨éƒ½åŒ…è£…åœ¨ `isPlatformBrowser()` æ£€æŸ¥ä¸­
- [x] å¯¼å…¥äº†å¿…è¦çš„ Angular å¹³å°æ£€æµ‹æ¨¡å—
- [x] æ„å»ºæˆåŠŸæ— é”™è¯¯
- [x] SSR é¢„æ¸²æŸ“æ­£å¸¸å·¥ä½œ
- [x] æµè§ˆå™¨ç«¯åŠŸèƒ½æ­£å¸¸

## æ€»ç»“

é€šè¿‡å®æ–½å¹³å°æ£€æµ‹æœºåˆ¶ï¼ŒæˆåŠŸè§£å†³äº† Angular 20 SSR ç¯å¢ƒä¸‹çš„ localStorage å†²çªé—®é¢˜ã€‚ç°åœ¨åº”ç”¨å¯ä»¥ï¼š

1. **æ­£å¸¸æ„å»ºå’Œéƒ¨ç½²**
2. **åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶ä¸æŠ¥é”™**
3. **åœ¨æµè§ˆå™¨ç«¯ä¿æŒå®Œæ•´åŠŸèƒ½**
4. **ä¸ºæœªæ¥çš„ SSR åŠŸèƒ½æä¾›è‰¯å¥½åŸºç¡€**

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ Angular Universalï¼ˆSSRï¼‰å…¼å®¹æ€§é—®é¢˜çš„æ ‡å‡†è§£å†³æ–¹æ¡ˆï¼Œé€‚ç”¨äºæ‰€æœ‰éœ€è¦åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„ Angular åº”ç”¨ã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024å¹´  
**å½±å“èŒƒå›´**: å…¨åº”ç”¨  
**ä¸¥é‡ç¨‹åº¦**: å·²è§£å†³  
**çŠ¶æ€**: âœ… å®Œæˆ