<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
             targetNamespace="http://camunda.org/schema/1.0/bpmn">

    <process id="leaveProcess" name="请假审批流程" isExecutable="true">
        
        <!-- 开始事件 -->
        <startEvent id="startEvent" name="开始"/>
        
        <!-- 部门经理审批 -->
        <userTask id="deptManagerApproval" name="部门经理审批" camunda:assignee="#{deptManagerId}">
            <documentation>部门经理审批请假申请</documentation>
            <extensionElements>
                <camunda:formData>
                    <camunda:formField id="approved" label="审批结果" type="boolean"/>
                    <camunda:formField id="comment" label="审批意见" type="string"/>
                </camunda:formData>
            </extensionElements>
        </userTask>
        
        <!-- 排他网关 - 判断是否需要HR审批 -->
        <exclusiveGateway id="needHrApproval" name="是否需要HR审批"/>
        
        <!-- HR审批 -->
        <userTask id="hrApproval" name="HR审批" camunda:assignee="#{hrManagerId}">
            <documentation>HR审批请假申请（长期请假或特殊假期）</documentation>
            <extensionElements>
                <camunda:formData>
                    <camunda:formField id="approved" label="审批结果" type="boolean"/>
                    <camunda:formField id="comment" label="审批意见" type="string"/>
                </camunda:formData>
            </extensionElements>
        </userTask>
        
        <!-- 排他网关 - 判断审批结果 -->
        <exclusiveGateway id="approvalDecision" name="审批决定"/>
        
        <!-- 审批通过 -->
        <serviceTask id="approvalSuccess" name="审批通过处理" camunda:class="org.max.cms.leave.service.LeaveApprovalSuccessDelegate"/>
        
        <!-- 审批拒绝 -->
        <serviceTask id="approvalReject" name="审批拒绝处理" camunda:class="org.max.cms.leave.service.LeaveApprovalRejectDelegate"/>
        
        <!-- 结束事件 -->
        <endEvent id="endEvent" name="结束"/>
        
        <!-- 流程连线 -->
        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="deptManagerApproval"/>
        
        <sequenceFlow id="flow2" sourceRef="deptManagerApproval" targetRef="needHrApproval"/>
        
        <!-- 需要HR审批的条件：请假天数>=5天 或 请假类型为产假、陪产假等 -->
        <sequenceFlow id="flow3" sourceRef="needHrApproval" targetRef="hrApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${days >= 5 || leaveType == 'MATERNITY' || leaveType == 'PATERNITY'}]]>
            </conditionExpression>
        </sequenceFlow>
        
        <!-- 不需要HR审批 -->
        <sequenceFlow id="flow4" sourceRef="needHrApproval" targetRef="approvalDecision">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${days < 5 && leaveType != 'MATERNITY' && leaveType != 'PATERNITY'}]]>
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow5" sourceRef="hrApproval" targetRef="approvalDecision"/>
        
        <!-- 审批通过 -->
        <sequenceFlow id="flow6" sourceRef="approvalDecision" targetRef="approvalSuccess">
            <conditionExpression xsi:type="tFormalExpression">${approved == true}</conditionExpression>
        </sequenceFlow>
        
        <!-- 审批拒绝 -->
        <sequenceFlow id="flow7" sourceRef="approvalDecision" targetRef="approvalReject">
            <conditionExpression xsi:type="tFormalExpression">${approved == false}</conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow8" sourceRef="approvalSuccess" targetRef="endEvent"/>
        <sequenceFlow id="flow9" sourceRef="approvalReject" targetRef="endEvent"/>
        
    </process>
    
</definitions>